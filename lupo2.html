<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<style>
body{margin:0;padding:0;background:transparent;overflow:hidden;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif}
.c{position:relative;width:650px;height:650px}
.sV{position:absolute;top:50%;width:200px;height:460px;border-radius:70px;transform:translateY(-50%);object-fit:cover;z-index:5;border:4px solid #40E0D0;box-shadow:0 0 30px #40E0D0,0 0 70px #40E0D0,0 0 110px #fff,inset 0 0 40px rgba(64,224,208,.6)}
#lV{left:-60px}#rV{right:-60px}
#cV{position:absolute;top:50%;left:50%;width:320px;height:460px;transform:translate(-50%,-50%);border-radius:30px;object-fit:cover;z-index:10;border:4px solid #40E0D0;box-shadow:0 0 30px #40E0D0,0 0 70px #40E0D0,0 0 110px #fff,inset 0 0 40px rgba(64,224,208,.6);animation:a 6s infinite ease-in-out}
@keyframes a{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.04)}}
#album{position:absolute;top:120px;left:50%;transform:translateX(-50%);width:130px;height:130px;overflow:hidden;border:3px solid #40E0D0;box-shadow:0 0 20px #40E0D0,0 0 40px #fff;transition:border-radius 1s,top 1s;z-index:15;animation:b 4s infinite ease-in-out}
@keyframes b{0%,100%{top:120px}50%{top:160px}}
#album img{width:100%;height:100%;object-fit:cover;border-radius:50%;transition:border-radius 1s}
#cI{position:absolute;top:50%;left:50%;width:320px;height:460px;transform:translate(-50%,-50%);z-index:8;object-fit:cover;pointer-events:none;border-radius:30px;opacity:.3;animation:c 4s infinite ease-in-out}
@keyframes c{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:.3}50%{transform:translate(-50%,-50%) scale(1.03);opacity:.5}}
#mC{position:absolute;top:500px;left:50%;transform:translateX(-50%);width:38%;overflow:hidden;height:25px;border-radius:6px;background:#40E0D0;border:2px solid red;padding:2px 0;z-index:20}
#m{display:inline-block;white-space:nowrap;color:#fff;font-size:14px;text-shadow:0 0 5px #40E0D0,0 0 10px #fff}
#ctrl{position:absolute;top:580px;left:50%;transform:translateX(-50%);display:flex;justify-content:center;gap:15px}
button,input[type=range]{padding:8px 12px;border-radius:6px;border:none;outline:none;cursor:pointer;font-size:14px;box-shadow:0 0 20px rgba(64,224,208,.7)}
#pB{background:#40E0D0;color:#fff}#sB{background:#FF3B3B;color:#fff}
#vS{-webkit-appearance:none;width:38%;background:#40E0D0;height:6px;border-radius:4px;margin-top:3px}
#vS::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;cursor:pointer}
.tS{position:absolute;top:calc(50% + 230px - 30px);width:200px;text-align:center;font-family:"Creepster",sans-serif;font-size:20px;color:#40E0D0;-webkit-text-stroke:2px #40E0D0;text-shadow:0 0 20px #40E0D0,0 0 40px #fff,0 0 60px #40E0D0;z-index:15;animation:d 4s infinite ease-in-out}
#lT{left:-60px}#rT{right:-60px}
@keyframes d{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.05);opacity:1}}
#eqC{position:absolute;top:440px;left:50%;transform:translateX(-50%);width:38%;height:35px;display:flex;align-items:flex-end;justify-content:space-between;gap:2px;z-index:25}
#eqC div{flex:1;background:#FF3B3B;border:1px solid #40E0D0;border-radius:3px;box-shadow:0 0 10px #40E0D0,0 0 20px #fff;transition:height .05s;height:5px;margin:0 1px}
</style>
</head>
<body>
<div class="c">
  <video id="lV" class="sV" autoplay loop muted playsinline>
    <source src="https://peppeagosto.github.io/immaggini/bn.mp4" type="video/mp4">
  </video>
  <video id="cV" autoplay loop muted playsinline>
    <source src="" type="video/mp4">
  </video>
  <video id="rV" class="sV" autoplay loop muted playsinline>
    <source src="https://peppeagosto.github.io/immaggini/bn.mp4" type="video/mp4">
  </video>
  <div id="lT" class="tS">CARTAIO</div>
  <div id="rT" class="tS">CARTAIO</div>
  
  <!-- Immagine di sfondo grande al centro -->
  <img id="cI" src="https://xatimg.com/image/aRbA0csVru2r.jpg">
  
  <div id="mC"><div id="m">Caricamento...</div></div>
  <div id="eqC"></div>
  
  <!-- Album cover piccola -->
  <div id="album">
    <img src="https://xatimg.com/image/aRbA0csVru2r.jpg" alt="Album Cover">
  </div>
  
  <div id="ctrl">
    <button id="pB">Play</button>
    <input type="range" id="vS" min="0" max="1" step="0.01" value="1">
    <button id="sB">Stop</button>
  </div>
  <audio id="audio" src="https://stream.zeno.fm/ylkruiq5e4fvv?advert=false" crossorigin="anonymous"></audio>
</div>

<script>
const a = document.getElementById("audio");
const b = document.querySelector("#album");
const c = document.querySelector("#album img");
const v = document.getElementById("vS");
const p = document.getElementById("pB");
const s = document.getElementById("sB");
const m = document.getElementById("m");
const eqC = document.getElementById("eqC");

let audioCtx, analyser, dataArray;

// Creazione barre EQ
const EQ_BARS = 16;
for(let i = 0; i < EQ_BARS; i++){
  let bar = document.createElement("div");
  eqC.appendChild(bar);
}
const bars = eqC.querySelectorAll("div");

// Play button
p.addEventListener("click", async () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 64;
    const source = audioCtx.createMediaElementSource(a);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    animateBars();
    pulseAlbum(); // avvia il pulsare dell'album con la musica
  }
  await a.play();
});

// Stop button
s.addEventListener("click", () => {
  a.pause();
  a.currentTime = 0;
});

// Volume
v.addEventListener("input", () => {
  a.volume = v.value;
});

// Animazione barre EQ
function animateBars() {
  if (!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  bars.forEach((bar, i) => {
    let h = dataArray[i] * 0.6;
    bar.style.height = `${Math.max(5, h)}px`;
  });
  requestAnimationFrame(animateBars);
}

// Pulsare album con i bassi
function pulseAlbum() {
  if (!analyser) return;
  let low = 0;
  dataArray.forEach((val, i) => { if (i < 4) low += val; });
  low /= 4;
  b.style.top = `${120 + (low/255*40)}px`;
  c.style.transform = `scale(${1 + low/255*0.12})`;
  requestAnimationFrame(pulseAlbum);
}

// Cambio forma album ogni 10 secondi
let rounded = true;
setInterval(() => {
  rounded = !rounded;
  b.style.borderRadius = rounded ? "50%" : "18px";
  c.style.borderRadius = rounded ? "50%" : "18px";
  b.style.top = rounded ? "120px" : "150px";
}, 10000);

// Typewriter titolo
let typeInterval;
function typeWriterLoop(text) {
  let i = 0;
  clearInterval(typeInterval);
  function type() {
    m.textContent = text.substring(0, i + 1);
    i++;
    if (i > text.length) {
      setTimeout(() => typeWriterLoop(text), 2000);
    }
  }
  typeInterval = setInterval(type, 50);
}

// Aggiornamento titolo e cover (fallback sempre la tua foto)
let lastTitle = "";
const api = "https://zenoplay.zenomedia.com/api/zenofm/nowplaying/ylkruiq5e4fvv";

async function fetchCover(artist, title) {
  try {
    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist + " " + title)}&limit=1&entity=song`);
    const data = await res.json();
    return data.results?.[0]?.artworkUrl100?.replace("100x100", "300x300") || "";
  } catch {
    return "";
  }
}

async function updateTrack() {
  try {
    const res = await fetch(api + "?t=" + Date.now());
    const data = await res.json();
    if (data.title !== lastTitle) {
      lastTitle = data.title;
      const fullTitle = `${data.artist || ""} - ${data.title || "Radio Cartaio Live"}`;
      typeWriterLoop(fullTitle);
      
      c.style.opacity = 0;
      const coverUrl = await fetchCover(data.artist || "", data.title || "");
      setTimeout(() => {
        c.src = coverUrl || "https://xatimg.com/image/aRbA0csVru2r.jpg";
        c.style.opacity = 1;
      }, 300);
    }
  } catch(err) {
    console.log("Errore aggiornamento:", err);
  }
}

setInterval(updateTrack, 2000);
updateTrack();

</script>
</body>
</html>
