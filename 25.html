<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Il Cartaio - Cometa (Audio Fix xat)</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body,html{height:100vh;overflow:hidden;background:#000;display:flex;justify-content:center;align-items:center;position:relative;font-family:Arial,sans-serif;}
  .container{position:relative;width:1330px;height:486px;text-align:center;}
  .vid{position:absolute;width:330px;height:486px;object-fit:cover;border-radius:10px;box-shadow:0 0 20px rgba(255,0,0,.7);z-index:2;}
  .left{left:-40px;top:0;}.right{right:-40px;top:0;}
  .center{position:absolute;left:50%;top:0;transform:translateX(-50%);width:728px;height:486px;z-index:3;border:3px solid #ff0000;border-radius:12px;box-shadow:0 0 30px rgba(255,0,0,0.8);animation:fade 20s infinite;}
  @keyframes fade{0%,40%{opacity:1}50%,90%{opacity:0}100%{opacity:1}}
  canvas{position:fixed;top:0;left:0;pointer-events:none;}
  #stars-canvas{z-index:1}#snow-canvas{z-index:4}#comet-canvas{z-index:5}

  /* PULSANTE GIGANTE - SOLO QUANDO VUOI TU */
  #playBtn{
    position:fixed !important;
    bottom:20px !important;
    left:50% !important;
    transform:translateX(-50%) !important;
    padding:16px 48px !important;
    font-size:20px !important;
    font-weight:bold !important;
    color:#fff !important;
    background:#c00 !important;
    border:4px solid #f00 !important;
    border-radius:26px !important;
    cursor:pointer !important;
    box-shadow:0 0 30px #f00, 0 0 60px rgba(255,0,0,0.9) !important;
    z-index:999999999 !important;
    pointer-events:auto !important;
    user-select:none !important;
    transition:all 0.22s !important;
    text-transform:uppercase;
    letter-spacing:1.5px;
    font-family:Arial Black, sans-serif;
  }
  #playBtn:hover{background:#e00 !important;transform:translateX(-50%) scale(1.05) !important;box-shadow:0 0 60px #ff0 !important;}
  #status{position:fixed;bottom:86px;left:50%;transform:translateX(-50%);color:#fff;font-weight:bold;z-index:9999999999;text-shadow:0 0 8px #000;pointer-events:none}
  #volWrap{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);z-index:9999999999;display:flex;align-items:center;gap:8px}
  #vol{width:160px}
</style>
</head>
<body>

<div class="container">
  <video class="vid left" autoplay loop muted playsinline preload="auto">
    <source src="https://peppeagosto.github.io/immaggini/25.mp4" type="video/mp4">
  </video>
  <video class="vid center" autoplay loop muted playsinline preload="auto">
    <source src="https://peppeagosto.github.io/immaggini/babbo.mp4" type="video/mp4">
  </video>
  <video class="vid right" autoplay loop muted playsinline preload="auto">
    <source src="https://peppeagosto.github.io/immaggini/25.mp4" type="video/mp4">
  </video>
</div>

<!-- PULSANTE: SOLO QUANDO CLICCHI TU -->
<button id="playBtn" onclick="handlePlayClick()">ASCOLTA GERRY</button>
<div id="status">Audio fermo</div>
<div id="volWrap" style="display:none;">
  <label for="vol" style="color:#fff;font-weight:bold;text-shadow:0 0 6px #000">Volume</label>
  <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" />
</div>

<!-- NOTA: l'elemento audio viene creato al volo via JS per gestire meglio i permessi -->
<canvas id="stars-canvas"></canvas>
<canvas id="snow-canvas"></canvas>
<canvas id="comet-canvas"></canvas>

<script>
/*
  VERSIONE RINFORZATA PER xat/edit:
  - crea l'elemento <audio> al primo click
  - imposta crossOrigin per evitare problemi CORS con AudioContext
  - usa AudioContext resume() su gesture per sbloccare l'audio
  - mostra stato e controllo volume
  - vari fallback se play() viene rifiutato
*/

const AUDIO_SRC = "https://peppeagosto.github.io/immaggini/25.mp3"; // il tuo mp3
let audioEl = null;
let audioCtx = null;
let audioSourceNode = null;
let isPlaying = false;

const btn = document.getElementById('playBtn');
const status = document.getElementById('status');
const volWrap = document.getElementById('volWrap');
const vol = document.getElementById('vol');

function createAudioElement() {
  // se giÃ  esiste ritorna
  if (audioEl) return audioEl;

  const a = document.createElement('audio');
  a.id = 'gerry';
  a.preload = 'auto';
  a.crossOrigin = 'anonymous'; // importante per AudioContext / CORS
  a.src = AUDIO_SRC;
  a.loop = false; // se vuoi loop true
  a.setAttribute('playsinline',''); // utile su mobile
  a.style.display = 'none';
  document.body.appendChild(a);
  audioEl = a;
  return a;
}

async function initAudioContext() {
  if (audioCtx) return audioCtx;
  try {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    // crea nodo sorgente collegato all'audio element
    audioSourceNode = audioCtx.createMediaElementSource(audioEl);
    audioSourceNode.connect(audioCtx.destination);
    return audioCtx;
  } catch(e) {
    console.warn("AudioContext non disponibile:", e);
    return null;
  }
}

async function tryPlayOnce() {
  status.innerText = "Sto avviando...";
  try {
    await audioEl.play();
    isPlaying = true;
    status.innerText = "In riproduzione";
    btn.innerText = "PAUSA GERRY";
    btn.style.background = "#090";
    volWrap.style.display = "flex";
    return true;
  } catch (err) {
    console.warn("play() rifiutato:", err);
    status.innerText = "Tocca di nuovo per consentire l'audio";
    return false;
  }
}

async function handlePlayClick() {
  // primo click: crea audio e AudioContext se necessario
  if (!audioEl) {
    createAudioElement();
    await initAudioContext();
  }

  // se AudioContext sospeso, prova a risvegliarlo
  if (audioCtx && audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch(e){ console.warn("resume() fallito", e); }
  }

  // se non sta suonando, tenta di avviare
  if (!isPlaying) {
    // riprova a caricare (in alcuni ambienti aiuta)
    try { audioEl.load(); } catch(e){ /* ignore */ }

    const ok = await tryPlayOnce();
    if (!ok) {
      // fallback: ricrea elemento audio e ritenta (alcuni iframes preferiscono elemento creato on-gesture)
      console.log("Tentativo fallback: ricreo audio e ritento");
      try {
        if (audioEl) { audioEl.pause(); audioEl.remove(); audioEl = null; }
        createAudioElement();
        await initAudioContext();
        const ok2 = await tryPlayOnce();
        if (!ok2) {
          status.innerText = "Impossibile riprodurre qui. Prova a cliccare direttamente sull'area o a caricare il file su dominio consentito da xat.";
        }
      } catch(e) {
        console.error("Fallback failed:", e);
        status.innerText = "Errore riproduzione: " + (e && e.message ? e.message : "unknown");
      }
    }
  } else {
    // se sta suonando, metti in pausa
    audioEl.pause();
    isPlaying = false;
    btn.innerText = "ASCOLTA GERRY";
    btn.style.background = "#c00";
    status.innerText = "Audio fermo";
  }
}

// volume control
vol.addEventListener('input', e=>{
  if (audioEl) audioEl.volume = parseFloat(e.target.value);
});

// --- CANVAS EFFETTI (restano inalterati) ---
const canvases = ['stars-canvas','snow-canvas','comet-canvas'].map(id=>document.getElementById(id));
const ctxs = canvases.map(c=>c.getContext('2d'));
const [sctx,nctx,cctx]=ctxs;
const resize=()=>canvases.forEach(c=>{c.width=innerWidth;c.height=innerHeight});
resize(); window.onresize=resize;

// STELLE
const stars=[],numStars=160;
class Star{constructor(){this.reset();} reset(){this.size=Math.random()*3.2+1;this.x=Math.random()*innerWidth;this.y=-60;this.speed=Math.random()*1.8+0.6;this.time=0;this.duration=Math.random()*18+12;this.phase=Math.random()*Math.PI*2;} update(){this.time+=0.016;this.y+=this.speed;if(this.time>this.duration||this.y>innerHeight+60)this.reset();} draw(){const pulse=0.75+0.25*Math.sin(this.time*6+this.phase);sctx.globalAlpha=pulse;sctx.shadowBlur=22;sctx.shadowColor='#fff';sctx.beginPath();sctx.arc(this.x,this.y,this.size,0,Math.PI*2);sctx.fillStyle='#fff';sctx.fill();if(this.size>2.3){sctx.shadowBlur=35;sctx.shadowColor='#ffd700';drawStar(sctx,this.x,this.y,this.size*2.2,this.size*0.9);}}}
for(let i=0;i<numStars;i++)stars.push(new Star());
function animateStars(){sctx.clearRect(0,0,innerWidth,innerHeight);stars.forEach(s=>{s.update();s.draw();});requestAnimationFrame(animateStars);}
animateStars();

// NEVE
const flakes=[],numFlakes=80;
class Flake{constructor(){this.reset();} reset(){this.x=Math.random()*innerWidth;this.y=-10;this.size=Math.random()*2+1;this.speed=Math.random()*1+0.5;this.opacity=Math.random()*0.5+0.5;this.wind=Math.random()*2-1;} update(){this.y+=this.speed;this.x+=this.wind*0.3;if(this.y>innerHeight||this.x<-20||this.x>innerWidth+20)this.reset();} draw(){nctx.globalAlpha=this.opacity;nctx.fillStyle='#fff';nctx.beginPath();nctx.arc(this.x,this.y,this.size,0,Math.PI*2);nctx.fill();} }
for(let i=0;i<numFlakes;i++)flakes.push(new Flake());
function animateSnow(){nctx.clearRect(0,0,innerWidth,innerHeight);flakes.forEach(f=>{f.update();f.draw();});requestAnimationFrame(animateSnow);}
animateSnow();

// COMETA
const comet={x:innerWidth+50,y:50,speedX:-5,speedY:3,size:28,trail:[],maxTrail:50};
function drawStar(ctx,cx,cy,R,r){let rot=Math.PI/2*3;ctx.beginPath();ctx.moveTo(cx,cy-R);for(let i=0;i<5;i++){ctx.lineTo(cx+Math.cos(rot)*R,cy+Math.sin(rot)*R);rot+=Math.PI/5;ctx.lineTo(cx+Math.cos(rot)*r,cy+Math.sin(rot)*r);rot+=Math.PI/5;}ctx.closePath();const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,R);grad.addColorStop(0,'#ffffff');grad.addColorStop(0.4,'#fff8a8');grad.addColorStop(1,'#ffdc64');ctx.fillStyle=grad;ctx.fill();}
function animateComet(){cctx.clearRect(0,0,innerWidth,innerHeight);comet.x+=comet.speedX;comet.y+=comet.speedY;if(comet.x<-50||comet.x>innerWidth+50)comet.speedX*=-1;if(comet.y<0||comet.y>innerHeight-50)comet.speedY*=-1;comet.trail.push({x:comet.x,y:comet.y});if(comet.trail.length>comet.maxTrail)comet.trail.shift();comet.trail.forEach((p,i)=>{const alpha=(i+1)/comet.trail.length;cctx.globalAlpha=alpha*0.7;cctx.shadowBlur=30;cctx.shadowColor=`rgba(255,220,100,${alpha})`;cctx.beginPath();cctx.arc(p.x,p.y,comet.size*0.5*alpha,0,Math.PI*2);cctx.fillStyle='#ffdc64';cctx.fill();});cctx.globalAlpha=1;cctx.shadowBlur=60;cctx.shadowColor='#ffd700';drawStar(cctx,comet.x,comet.y,comet.size,comet.size*0.45);requestAnimationFrame(animateComet);}
animateComet();
</script>
</body>
</html>






























