<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GENERATO DA CARTAIO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: transparent;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .player-container {
      width: 780px;
      height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    /* ALBUM CENTRALE */
    .album-center {
      width: 380px;
      height: 400px;
      position: relative;
      z-index: 10;
      border-radius: 12px;
      overflow: hidden;
      border: 5px solid;
      border-image: linear-gradient(45deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff) 1;
      animation: rainbow-border 4s linear infinite;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @keyframes rainbow-border {
      0% { border-image-source: linear-gradient(45deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); }
      100% { border-image-source: linear-gradient(45deg, #ff00ff, #0000ff, #00ffff, #00ff00, #ffff00, #ff7700, #ff0000); }
    }

    #placeholder-image {
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 12px;
    }

    /* VIDEO LATERALI */
    .video-container {
      width: 170px;
      height: 400px;
      border-radius: 12px;
      border: 5px solid;
      border-image: linear-gradient(45deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff) 1;
      animation: rainbow-border 4s linear infinite;
      position: relative;
      box-sizing: border-box;
    }

    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 9px;
      position: absolute;
      top: 0; 
      left: 0;
    }

    /* Slider volume */
    input[type=range] {
      -webkit-appearance: none;
      width: 200px;
      height: 10px;
      border-radius: 5px;
      background: #333;
      outline: none;
      cursor: pointer;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff7518, #ff00ff, #00ffff);
      border: 2px solid white;
      cursor: pointer;
    }

    /* Box ascoltatori */
    .listeners-box-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 16px;
    }
    .listeners-box {
      background: rgba(255,117,24,0.15);
      border: 2px solid #ff7518;
      border-radius: 12px;
      padding: 10px 20px;
      color: #ff7518;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 0 15px rgba(255,117,24,0.3);
    }
    .side-image {
      width: 45px;
      height: 45px;
      background: url('https://xatimg.com/image/fq3g4IMqEgvh.gif') center/contain no-repeat;
    }

    /* Titoli scorrevoli */
    .scroll-container {
      width: 320px;
      height: 44px;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(90deg, #ff7518, #ff0000, #4b0082);
      margin-bottom: 20px;
      padding: 0 12px;
    }
    .scrolling-text {
      white-space: nowrap;
      padding-left: 100%;
      animation: scroll 14s linear infinite;
      font-size: 17px;
      font-weight: 600;
      color: white;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* Pulsanti Play/Stop */
    .control-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(45deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
      background-size: 300% 300%;
      animation: rainbow-bg 3s ease infinite;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .control-button:hover { transform: scale(1.1); }
    @keyframes rainbow-bg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .flex-center-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 25px;
    }

    /* NOTE GIF */
    .music-notes {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }
    .note-gif {
      position: absolute;
      width: 40px;
      height: 40px;
      background: url('https://xatimg.com/image/WtkE3iY57M3W.png') center/contain no-repeat;
      animation: fall linear forwards;
      opacity: 0.9;
      filter: drop-shadow(0 0 8px currentColor);
      transform-origin: center;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(700px) rotate(360deg); opacity: 0; }
    }
    .note-gif.c1 { filter: hue-rotate(0deg) drop-shadow(0 0 8px #ff3366); }
    .note-gif.c2 { filter: hue-rotate(60deg) drop-shadow(0 0 8px #ffff33); }
    .note-gif.c3 { filter: hue-rotate(30deg) drop-shadow(0 0 8px #ff8800); }
    .note-gif.c4 { filter: hue-rotate(150deg) drop-shadow(0 0 8px #00ff99); }
    .note-gif.c5 { filter: hue-rotate(200deg) drop-shadow(0 0 8px #00ccff); }
  </style>
</head>

<body>
  <div class="player-container">

    <!-- VIDEO + ALBUM -->
    <div class="flex flex-center-row mb-6">
      <div class="video-container">
        <video autoplay loop muted>
          <source src="https://peppeagosto.github.io/immaggini/lo.mp4" type="video/mp4">
        </video>
      </div>

      <div class="album-center">
        <div id="placeholder-image"></div>
      </div>

      <div class="video-container">
        <video autoplay loop muted>
          <source src="https://peppeagosto.github.io/immaggini/lo.mp4" type="video/mp4">
        </video>
      </div>
    </div>

    <!-- Titoli scorrevoli -->
    <div class="scroll-container">
      <div id="scrolling-titles" class="scrolling-text">Caricamento...</div>
    </div>

    <!-- Controlli -->
    <div class="flex flex-col items-center w-full">
      <div class="listeners-box-wrapper">
        <div class="side-image"></div>
        <div class="listeners-box" id="listeners-count">Ascoltatori: --</div>
        <div class="side-image"></div>
      </div>

      <div class="flex justify-center items-center space-x-8">
        <button id="playButton" class="control-button">Play</button>
        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
        <button id="stopButton" class="control-button">Stop</button>
      </div>
    </div>

    <!-- NOTE GIF -->
    <div class="music-notes" id="musicNotes"></div>
  </div>

  <!-- Audio -->
  <audio id="audio"></audio>

  <script>
    // AUDIO
    let audio = null;

    function createAudio() {
      if (audio) {
        audio.pause();
        audio.src = '';
        audio.load();
      }
      audio = new Audio("https://sp1.server89.com:7018/stream");
      audio.volume = volumeControl.value;
      return audio;
    }

    // ELEMENTI
    const playButton = document.getElementById("playButton");
    const stopButton = document.getElementById("stopButton");
    const volumeControl = document.getElementById("volumeControl");
    const placeholderImage = document.getElementById("placeholder-image");
    const scrollingTitles = document.getElementById("scrolling-titles");
    const listenersCount = document.getElementById("listeners-count");
    const notesContainer = document.getElementById("musicNotes");

    let isFetching = false;

    // FUNZIONI
    function stripHTML(html) {
      return html.replace(/<[^>]*>/g,'');
    }

    async function updateCoverCopertina() {
      if(isFetching) return;
      isFetching = true;

      const defaultImage = 'https://xatimg.com/image/P80vHTsnPY2D.png';

      try {
        const res = await fetch('https://sp1.server89.com:7018/7.html');
        const text = await res.text();
        const lines = text.split('\n');
        const firstLine = lines[0].split(',');
        const listeners = stripHTML(firstLine[0]) || 'N/A';
        const trackName = stripHTML(firstLine[6]) || 'N/A';

        listenersCount.textContent = 'Ascoltatori: ' + listeners;
        scrollingTitles.textContent = trackName;

        // Cover da iTunes
        let coverUrl = defaultImage;
        if(trackName) {
          try {
            const itunesRes = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(trackName)}&media=music&entity=song&limit=1`);
            const itunesData = await itunesRes.json();
            if(itunesData.results && itunesData.results.length > 0) {
              coverUrl = itunesData.results[0].artworkUrl100.replace('100x100','300x300');
            }
          } catch(e) {
            console.log('Errore iTunes:', e);
          }
        }
        placeholderImage.style.backgroundImage = `url('${coverUrl}')`;
        placeholderImage.style.display = 'block';

      } catch {
        placeholderImage.style.backgroundImage = `url('${defaultImage}')`;
        placeholderImage.style.display = 'block';
      } finally {
        isFetching = false;
      }
    }

    // PLAY / STOP
    playButton.addEventListener('click', () => {
      createAudio().play();
      updateCoverCopertina();
      if(!window.updateInterval) {
        window.updateInterval = setInterval(updateCoverCopertina, 35000);
      }
    });

    stopButton.addEventListener('click', () => {
      if(audio) {
        audio.pause();
        audio.currentTime = 0;
      }
    });

    volumeControl.addEventListener('input', e => {
      if(audio) audio.volume = e.target.value;
    });

    // NOTE ANIMATE
    const colors = ['c1','c2','c3','c4','c5'];
    let noteCount = 0;
    const maxNotes = 25;

    function createNote() {
      if(noteCount >= maxNotes) return;
      const note = document.createElement('div');
      note.className = 'note-gif ' + colors[noteCount % colors.length];
      note.style.left = Math.random()*100+'%';
      note.style.animationDuration = Math.floor(Math.random()*4 + 8) + 's';
      notesContainer.appendChild(note);
      noteCount++;

      setTimeout(() => {
        if(note.parentNode) note.remove();
        noteCount--;
      }, 13000);
    }

    let delay = 0;
    for(let i=0; i<maxNotes; i++){
      setTimeout(createNote, delay);
      delay += 500;
    }

    // INIT
    updateCoverCopertina();
    setInterval(updateCoverCopertina, 35000);
  </script>
</body>
</html>
