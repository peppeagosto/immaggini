<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PLAYER CARTAIO</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<style>
body {
  background: transparent;
  overflow: hidden;
  font-family: 'Poppins', sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.player-container {
  width: 780px;
  height: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* VIDEO CENTRALE */
.album-center {
  width: 380px;
  height: 400px;
  position: relative;
  z-index: 10;
  border-radius: 12px;
  overflow: hidden;
  border: 5px solid;
  border-image: linear-gradient(45deg,#ff0000,#ff7700,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff) 1;
  animation: rainbow-border 4s linear infinite;
  display: flex;
  justify-content: center;
  align-items: center;
}

#coverArt {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top:0; left:0;
  display:none;
}

#centralVideo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0; left: 0;
}

/* VIDEO LATERALI */
.video-container {
  width: 170px;
  height: 400px;
  border-radius: 12px;
  border: 5px solid;
  border-image: linear-gradient(45deg,#ff0000,#ff7700,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff) 1;
  animation: rainbow-border 4s linear infinite;
  position: relative;
  box-sizing: border-box;
}
.video-container video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 9px;
}

@keyframes rainbow-border {
  0% { border-image-source: linear-gradient(45deg,#ff0000,#ff7700,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff); }
  100% { border-image-source: linear-gradient(45deg,#ff00ff,#0000ff,#00ffff,#00ff00,#ffff00,#ff7700,#ff0000); }
}

/* SCROLLING TEXT */
.scroll-container {
  width: 320px;
  height: 44px;
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(90deg,#ff7518,#ff0000,#4b0082);
  margin: 20px 0;
  padding: 0 12px;
}
.scrolling-text {
  white-space: nowrap;
  padding-left: 100%;
  animation: scroll 14s linear infinite;
  font-size: 17px;
  font-weight: 600;
  color: white;
}
@keyframes scroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* CONTROLLI */
.control-button {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(45deg,#ff0000,#ff7700,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff);
  background-size: 300% 300%;
  animation: rainbow-bg 3s ease infinite;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition: transform 0.2s;
}
.control-button:hover { transform: scale(1.1); }

@keyframes rainbow-bg {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.flex-center-row { display: flex; align-items: center; justify-content: center; gap: 25px; }

.listeners-box-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 16px;
}
.listeners-box {
  background: rgba(255,117,24,0.15);
  border: 2px solid #ff7518;
  border-radius: 12px;
  padding: 10px 20px;
  color: #ff7518;
  font-size: 18px;
  font-weight: 600;
  box-shadow: 0 0 15px rgba(255,117,24,0.3);
}
.side-image {
  width: 45px;
  height: 45px;
  background: url('https://xatimg.com/image/fq3g4IMqEgvh.gif') center/contain no-repeat;
}

/* NOTE MUSICALI */
.music-notes {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}
.note-gif {
  position: absolute;
  width: 40px;
  height: 40px;
  background: url('https://xatimg.com/image/WtkE3iY57M3W.png') center/contain no-repeat;
  animation: fall linear forwards;
  opacity: 0.9;
  transform-origin: center;
}
@keyframes fall {
  0% { transform: translateY(-100px) rotate(0deg); opacity:1; }
  100% { transform: translateY(700px) rotate(360deg); opacity:0; }
}
.note-gif.c1 { filter: hue-rotate(0deg) drop-shadow(0 0 8px #ff3366); }
.note-gif.c2 { filter: hue-rotate(60deg) drop-shadow(0 0 8px #ffff33); }
.note-gif.c3 { filter: hue-rotate(30deg) drop-shadow(0 0 8px #ff8800); }
.note-gif.c4 { filter: hue-rotate(150deg) drop-shadow(0 0 8px #00ff99); }
.note-gif.c5 { filter: hue-rotate(200deg) drop-shadow(0 0 8px #00ccff); }
</style>
</head>
<body>
<div class="player-container">
  <div class="flex flex-center-row mb-6">
    <!-- VIDEO LATERALE SX -->
    <div class="video-container">
      <video autoplay loop muted>
        <source src="https://peppeagosto.github.io/immaggini/lo.mp4" type="video/mp4">
      </video>
    </div>

    <!-- VIDEO CENTRALE -->
    <div class="album-center">
      <img id="coverArt" alt="Cover Art">
      <video autoplay loop muted id="centralVideo">
        <source src="https://peppeagosto.github.io/immaggini/simo.mp4" type="video/mp4">
      </video>
    </div>

    <!-- VIDEO LATERALE DX -->
    <div class="video-container">
      <video autoplay loop muted>
        <source src="https://peppeagosto.github.io/immaggini/lo.mp4" type="video/mp4">
      </video>
    </div>
  </div>

  <!-- TITOLI SCORREVOLI -->
  <div class="scroll-container">
    <div id="scrolling-titles" class="scrolling-text">Caricamento...</div>
  </div>

  <!-- CONTROLLI -->
  <div class="flex flex-col items-center w-full">
    <div class="listeners-box-wrapper">
      <div class="side-image"></div>
      <div class="listeners-box" id="listeners-count">Ascoltatori: --</div>
      <div class="side-image"></div>
    </div>
    <div class="flex justify-center items-center space-x-8">
      <button id="playButton" class="control-button">Play</button>
      <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
      <button id="stopButton" class="control-button">Stop</button>
    </div>
  </div>

  <div class="music-notes" id="musicNotes"></div>
</div>

<!-- AUDIO -->
<audio id="audio" type="audio/mpeg"></audio>

<script>
const audio = document.getElementById("audio");
const playButton = document.getElementById("playButton");
const stopButton = document.getElementById("stopButton");
const volumeControl = document.getElementById("volumeControl");
const scrollingTitles = document.getElementById("scrolling-titles");
const listenersCount = document.getElementById("listeners-count");
const centralVideo = document.getElementById("centralVideo");
const coverArt = document.getElementById("coverArt");

playButton.addEventListener("click", ()=>{
  audio.src="https://cast.server89.com:8000/radio.mp3";
  audio.play().catch(e=>console.log("Errore audio:", e));
  updateCoverArt();
});
stopButton.addEventListener("click", ()=>{ audio.pause(); audio.currentTime=0; });
volumeControl.addEventListener("input", e=>{ audio.volume=e.target.value; });

let isFetching=false;
async function updateCoverArt(){
  if(isFetching) return;
  isFetching=true;
  try{
    const res = await fetch("https://cast.server89.com:8000/status-json.xsl");
    const data = await res.json();
    
    // Gestione più robusta della struttura JSON
    let source = null;
    if(data.icestats && data.icestats.source){
      // Se source è un array
      if(Array.isArray(data.icestats.source)){
        source = data.icestats.source[0];
      } else {
        // Se source è un oggetto singolo
        source = data.icestats.source;
      }
    }
    
    if(!source){
      throw new Error("Nessuna fonte Icecast trovata");
    }

    const listeners = source.listeners ?? "N/A";
    listenersCount.textContent = "Ascoltatori: " + listeners;

    const trackName = (source.title || "").trim();
    scrollingTitles.textContent = trackName || "Caricamento...";

    if(trackName){
      try{
        const iTunesRes = await fetch("https://itunes.apple.com/search?term=" + encodeURIComponent(trackName) + "&media=music&entity=song&limit=1");
        const iTunesJson = await iTunesRes.json();
        if(iTunesJson.results && iTunesJson.results.length>0){
          coverArt.src=iTunesJson.results[0].artworkUrl100.replace("100x100","600x600");
          coverArt.style.display="block";
          centralVideo.style.display="none";
        } else {
          coverArt.style.display="none";
          centralVideo.style.display="block";
        }
      }catch(e){ 
        console.log("Errore iTunes:", e); 
        coverArt.style.display="none"; 
        centralVideo.style.display="block"; 
      }
    } else {
      coverArt.style.display="none";
      centralVideo.style.display="block";
    }

  } catch(e){
    console.log("Errore Icecast fetch:", e);
    listenersCount.textContent = "Ascoltatori: --";
    scrollingTitles.textContent = "Radio in streaming";
    coverArt.style.display="none";
    centralVideo.style.display="block";
  } finally{ 
    isFetching=false; 
  }
}

updateCoverArt();
setInterval(updateCoverArt, 35000);

// NOTE MUSICALI
const notesContainer=document.getElementById("musicNotes");
const colors=['c1','c2','c3','c4','c5'];
let noteCount=0,maxNotes=25;
function createNote(){
  if(noteCount>=maxNotes) return;
  const div=document.createElement("div");
  div.className="note-gif "+colors[noteCount%colors.length];
  div.style.left=Math.random()*100+"%";
  div.style.animationDuration=(Math.random()*4+8)+"s";
  notesContainer.appendChild(div);
  noteCount++;
  setTimeout(()=>{div.remove(); noteCount--;},13000);
}
for(let i=0;i<maxNotes;i++){ setTimeout(createNote,i*500); }
</script>
</body>
</html>
